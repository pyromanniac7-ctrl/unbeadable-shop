<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes"/>
<title>Unbeadable Shop</title>
<style>
/* (original styles unchanged) */
body { font-family: Arial,sans-serif; margin:0; background:#f5f7fb; }
header { background:#7c3aed; color:white; padding:30px; text-align:center; }
.container { max-width:1100px; margin:40px auto; padding:20px; }
.grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:20px; }
.card { background:white; padding:20px; border-radius:12px; box-shadow:0 8px 20px rgba(0,0,0,.08); }
.price { color:#7c3aed; font-weight:bold; }
button { margin-top:10px; width:100%; padding:10px; background:#7c3aed; color:white; border:none; border-radius:8px; cursor:pointer; }
button:hover { background:#6d28d9; }
#cart,#admin { background:white; padding:20px; border-radius:12px; margin-top:40px; }
.modal { position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; justify-content:center; align-items:center; z-index:2000; }
.modal-content { background:white; padding:20px; border-radius:12px; width:90%; max-width:400px; text-align:center; }
.color-picker { display:flex; flex-wrap:wrap; gap:10px; justify-content:center; }
.color-option { width:30px; height:30px; border-radius:50%; cursor:pointer; border:2px solid #ccc; }
.color-option.selected { border:3px solid #7c3aed; }
.deleteBtn { background:#dc2626; margin-top:8px; }
.deleteBtn:hover { background:#b91c1c; }
.doneBadge { color:green; font-weight:bold; }
.pendingBadge { color:#ca8a04; font-weight:bold; }
#myOrdersBtn { position:fixed; top:15px; right:15px; width:auto; padding:10px 14px; display:flex; align-items:center; gap:8px; }
#myOrdersPanel { position:fixed; top:60px; right:15px; background:white; padding:15px; border-radius:12px; width:300px; max-height:70vh; overflow:auto; display:none; box-shadow:0 10px 25px rgba(0,0,0,.2); }
#ratingBox { position: fixed; top:15px; right:140px; background:white; padding:8px 12px; border-radius:12px; box-shadow:0 8px 20px rgba(0,0,0,.15); display:flex; align-items:center; gap:6px; z-index:1000; }
.star { font-size:20px; cursor:pointer; color:#d1d5db; transition: transform 140ms ease; }
.star.active { color:#facc15; transform: scale(1.05); }
.star.locked { cursor:default; }
#ratingGraphPanel { position: fixed; top:60px; right:280px; background:white; padding:12px; border-radius:12px; box-shadow:0 8px 20px rgba(0,0,0,.15); width:260px; z-index:1000; display:none; }
.barContainer { display:flex; align-items:center; gap:8px; margin-bottom:6px; }
.barLabel { width:24px; font-size:12px; text-align:right; }
.barWrap { display:flex; align-items:center; gap:8px; flex:1; }
.barBg { background:#e5e7eb; flex:1; height:12px; border-radius:6px; overflow:hidden; }
.bar { height:12px; border-radius:6px; width:0%; background:#7c3aed; transition: width 300ms ease; }
.barCount { font-size:12px; width:28px; text-align:left; }
.avgRating { text-align:center; font-weight:bold; margin-bottom:8px; font-size:14px; }
#toggleRatingGraph { position: fixed; top:15px; right:460px; padding:6px 8px; border-radius:10px; border:none; background:#7c3aed; color:white; cursor:pointer; z-index:1000; font-size:12px; }
#toggleRatingGraph:hover { background:#6d28d9; }
#tipModal .modal-content button, #extraModal .modal-content button { margin-top:8px; width:auto; padding:8px 12px; margin-right:6px; }
.adminOrderBtn { margin-left:8px; padding:6px 8px; border-radius:6px; background:#10b981; color:white; border:none; cursor:pointer; }
.adminOrderBtn:hover { background:#059669; }
/* small styles for delete modal buttons */
#deleteModal .modal-content button { margin:6px; padding:8px 12px; border-radius:6px; cursor:pointer; }
#deleteYes { background:#ef4444; color:white; border:none; }
#deleteNo { background:#6b7280; color:white; border:none; }
/* badge for My Orders */
#myOrdersBadge {
  display:inline-flex;
  min-width:20px;
  height:20px;
  padding:0 6px;
  align-items:center;
  justify-content:center;
  border-radius:999px;
  background:#ef4444;
  color:white;
  font-weight:bold;
  font-size:12px;
  box-shadow:0 2px 6px rgba(0,0,0,0.15);
}
/* ADDED: round bracelet images above text (only added, nothing removed) */
.bracelet-img{
  width:120px;
  height:120px;
  object-fit:cover;
  border-radius:50%;
  display:block;
  margin:0 auto 10px;
  box-shadow:0 6px 18px rgba(0,0,0,0.12);
}
/* ADDED: customization overrides using CSS variables - these are additional rules (do not remove anything) */
:root {
  --accent: #7c3aed;
  --accent-hover: #6d28d9;
}
/* override only the GUI (not white areas) to reflect selected accent */
header { background: var(--accent) !important; }
.price { color: var(--accent) !important; }
button { background: var(--accent) !important; color: white !important; }
button:hover { background: var(--accent-hover) !important; }
#toggleRatingGraph { background: var(--accent) !important; }
#toggleRatingGraph:hover { background: var(--accent-hover) !important; }
.bar { background: var(--accent) !important; }
.adminOrderBtn { background: var(--accent) !important; }
.adminOrderBtn:hover { background: var(--accent-hover) !important; }
/* keep white backgrounds untouched - we only change accent colors */
/* New: container for Customize placed under My Orders (positioned but non-destructive)
   top is set dynamically via JS so it stays exactly 3px below the My Orders button. */
#customizeContainer{
  position: fixed;
  right: 15px;
  top: 0; /* will be overwritten by JS at runtime to place it under the My Orders button with 3px gap */
  width: 300px;
  z-index: 1000;
  text-align:center;
  background: transparent; /* keep transparent so it doesn't block view */
}
#customizeContainer .inner {
  background: white;
  padding:10px;
  border-radius:10px;
  box-shadow:0 8px 20px rgba(0,0,0,0.12);
}
#customizeContainer p { margin:6px 0 8px 0; font-weight:bold; }
#customizeContainer .info { margin-top:8px; font-size:12px; color:#555; }
@media (max-width:700px){
  /* on small screens move customize to left so it doesn't overlap */
  #customizeContainer { right: 15px; top: auto; bottom: 15px; width: 260px; }
}
/* ADDED: Enhanced mobile & touchscreen improvements (only additions, no removals) */
@media (max-width: 768px) {
  .grid { grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 16px; }
  .card { padding: 16px; }
  button { 
    padding: 14px; 
    font-size: 17px; 
    min-height: 52px; 
    touch-action: manipulation;
  }
  .color-option { 
    width: 48px; 
    height: 48px; 
    touch-action: manipulation;
  }
  .star { 
    font-size: 28px; 
    touch-action: manipulation;
  }
  #myOrdersBtn { 
    padding: 14px 18px; 
    font-size: 17px; 
    min-height: 52px;
    min-width: 140px;
    touch-action: manipulation;
  }
  #myOrdersPanel { 
    width: calc(100vw - 30px); 
    right: 15px; 
    max-height: 80vh; 
    padding: 14px; 
    top: 70px;
  }
  #ratingBox { 
    right: 15px; 
    top: 80px; 
    padding: 12px 16px; 
    gap: 10px;
  }
  #toggleRatingGraph { 
    right: 15px; 
    top: 15px; 
    padding: 12px 16px; 
    font-size: 15px; 
    min-height: 52px;
  }
  #ratingGraphPanel { 
    top: 140px; 
    right: 15px; 
    width: calc(100vw - 30px); 
    padding: 14px; 
  }
  .modal-content { 
    width: 92%; 
    max-width: none; 
    padding: 20px; 
  }
  .color-picker { gap: 18px; }
  #customizeContainer { 
    width: calc(100vw - 30px); 
    right: 15px; 
    bottom: 15px; 
    top: auto; 
  }
  input { 
    padding: 14px; 
    font-size: 17px; 
    min-height: 52px;
    box-sizing: border-box;
  }
  .adminOrderBtn { 
    padding: 10px 12px; 
    font-size: 15px; 
    min-height: 48px; 
    margin-left: 6px;
    touch-action: manipulation;
  }
  .deleteBtn { 
    padding: 10px; 
    font-size: 15px; 
    min-height: 48px; 
    touch-action: manipulation;
  }
  /* Ensure all interactive elements have sufficient touch target */
  button, .color-option, .star, #myOrdersBtn, .adminOrderBtn, .deleteBtn {
    -webkit-tap-highlight-color: transparent;
  }
}
/* Global touch improvements (applies everywhere) - ENHANCED */
* {
  -webkit-tap-highlight-color: rgba(0,0,0,0.1);
}
button, input, .color-option, .star {
  touch-action: manipulation;
}
/* Enhanced touch targets for ALL buttons - DESKTOP & MOBILE */
button {
  min-height: 44px;
  min-width: 44px;
  cursor: pointer;
  user-select: none;
  -webkit-user-select: none;
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
}
/* Touch feedback animation for all interactive elements */
button:active, .color-option:active, .star:active, .adminOrderBtn:active, .deleteBtn:active {
  transform: scale(0.97);
  transition: transform 0.1s ease;
}
/* Ensure proper spacing for touch */
.card button {
  margin-top: 12px;
}
/* Better touch for modal buttons */
.modal-content button {
  min-height: 48px;
  margin: 8px 4px;
  touch-action: manipulation;
}
/* Input fields touch-friendly */
input {
  min-height: 44px;
  padding: 12px;
  font-size: 16px;
  border: 1px solid #d1d5db;
  border-radius: 8px;
  box-sizing: border-box;
  -webkit-appearance: none;
  appearance: none;
  touch-action: manipulation;
}
/* Color options enhanced touch */
.color-option {
  min-width: 44px;
  min-height: 44px;
  touch-action: manipulation;
  user-select: none;
  -webkit-user-select: none;
}
/* Stars enhanced touch */
.star {
  min-width: 32px;
  min-height: 32px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  touch-action: manipulation;
  user-select: none;
  -webkit-user-select: none;
}
/* Admin buttons touch-friendly */
.adminOrderBtn {
  touch-action: manipulation;
  min-height: 44px;
  user-select: none;
  -webkit-user-select: none;
}
/* Delete buttons touch-friendly */
.deleteBtn {
  touch-action: manipulation;
  min-height: 44px;
  user-select: none;
  -webkit-user-select: none;
}
</style>
</head>
<body>
<div id="ratingBox">
  <span class="star" data-star="1">★</span>
  <span class="star" data-star="2">★</span>
  <span class="star" data-star="3">★</span>
  <span class="star" data-star="4">★</span>
  <span class="star" data-star="5">★</span>
</div>
<div id="ratingGraphPanel">
  <div class="avgRating" id="avgRating">Average: 0 ★</div>
  <div id="ratingBars">
    <!-- bars will be rendered here (5→1) -->
  </div>
</div>
<button id="toggleRatingGraph">Ratings</button>
<!-- ADDED: badge element inside/next to the button (additive only) -->
<button id="myOrdersBtn" aria-haspopup="true" aria-expanded="false">My Orders <span id="myOrdersBadge">0</span></button>
<div id="myOrdersPanel" aria-hidden="true">
  <h3>My Orders</h3>
  <!-- ADDED: lookup controls (additive only) -->
  <div style="margin-bottom:10px;">
    <input id="lookupInput" placeholder="Order code, name, or email" style="width:100%; padding:8px; margin-bottom:6px; box-sizing:border-box;">
    <div style="display:flex; gap:6px;">
      <button id="lookupBtn" style="flex:1; width:auto; padding:8px;">Find</button>
      <button id="clearLookupBtn" style="flex:1; width:auto; padding:8px; background:#6b7280;">Clear</button>
    </div>
  </div>
  <div id="myOrders"></div>
  <!-- NOTE: customize controls were moved OUTSIDE this element per your request -->
</div>
<!-- CUSTOMIZE CONTAINER placed UNDER the My Orders panel (moved here) -->
<div id="customizeContainer" aria-hidden="false">
  <div class="inner">
    <div style="margin-top:10px; text-align:center;">
      <button id="customizeToggle" style="width:auto; padding:8px 12px; border-radius:8px;">Customize</button>
    </div>
    <!-- Color picker panel for customization (hidden until Customize pressed) -->
    <div id="customizePanel" style="display:none; margin-top:12px;">
      <p>Pick an accent color (can't choose white)</p>
      <div id="customizePicker" class="color-picker"></div>
      <div class="info">Changes apply instantly. White is intentionally not available.</div>
    </div>
  </div>
</div>
<header>
<h1>Unbeadable</h1>
<p>Handmade Rubber Band Bracelets</p>
</header>
<div class="container">
<h2>Shop</h2>
<div class="grid" id="shopGrid"></div>
<div id="cart">
<h2>Cart</h2>
<div id="items"></div>
<p><strong>Total:</strong> $<span id="total">0.00</span></p>
<input id="name" placeholder="Your name">
<button id="checkout">Place Order</button>
</div>
<div id="admin">
<h2>Admin Panel</h2>
<input id="adminEmail" placeholder="Admin email">
<input id="adminPass" type="password" placeholder="Admin password">
<button id="adminLogin">Login</button>
<div id="orders"></div>
</div>
</div>
<div id="colorModal" class="modal">
<div class="modal-content">
<h3>Select up to 5 colors</h3>
<div class="color-picker" id="colorPicker"></div>
<button id="confirmColors">Add to Cart</button>
<button id="closeModal">Cancel</button>
</div>
</div>
<div id="tipModal" class="modal">
<div class="modal-content">
<h3>Would you like to leave a tip?</h3>
<button data-tip="1">$1</button>
<button data-tip="2">$2</button>
<button data-tip="3">$3</button>
<button data-tip="0">Skip</button>
</div>
</div>
<div id="extraModal" class="modal">
<div class="modal-content">
<p>You picked more than 5 colors. Each extra color costs $0.25. Add anyway?</p>
<button id="extraYes">Yes</button>
<button id="extraNo">No</button>
</div>
</div>
<!-- DELETE CONFIRMATION MODAL (added) -->
<div id="deleteModal" class="modal">
  <div class="modal-content">
    <p>Do you want to delete this order?</p>
    <button id="deleteYes">Yes</button>
    <button id="deleteNo">No</button>
  </div>
</div>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
// --- Firebase Config ---
const firebaseConfig = {
  apiKey: "AIzaSyAabIc-81hx89cRxMxiDuIYV7AXvc7Gdto",
  authDomain: "unbeadable-2e4f1.firebaseapp.com",
  projectId: "unbeadable-2e4f1",
  appId: "1:904715339138:web:0879a7b347805691d53b9b"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
// --- DOM Elements ---
const myOrdersBtn = document.getElementById("myOrdersBtn");
const myOrdersPanel = document.getElementById("myOrdersPanel");
const myOrdersDiv = document.getElementById("myOrders");
const myOrdersBadge = document.getElementById("myOrdersBadge");
const stars = document.querySelectorAll(".star");
const shopGrid = document.getElementById("shopGrid");
const colorModal = document.getElementById("colorModal");
const closeModal = document.getElementById("closeModal");
const confirmColors = document.getElementById("confirmColors");
const checkout = document.getElementById("checkout");
const items = document.getElementById("items");
const total = document.getElementById("total");
const adminLogin = document.getElementById("adminLogin");
const adminEmail = document.getElementById("adminEmail");
const adminPass = document.getElementById("adminPass");
const ordersDiv = document.getElementById("orders");
const tipModal = document.getElementById("tipModal");
const extraModal = document.getElementById("extraModal");
const extraYes = document.getElementById("extraYes");
const extraNo = document.getElementById("extraNo");
const toggleRatingGraph = document.getElementById("toggleRatingGraph");
const nameInput = document.getElementById("name");
// Lookup controls (ADDED)
const lookupInput = document.getElementById("lookupInput");
const lookupBtn = document.getElementById("lookupBtn");
const clearLookupBtn = document.getElementById("clearLookupBtn");
// Delete modal elements (added)
const deleteModal = document.getElementById("deleteModal");
const deleteYes = document.getElementById("deleteYes");
const deleteNo = document.getElementById("deleteNo");
let orderToDeleteId = null;
// Customize elements (moved outside My Orders)
const customizeToggle = document.getElementById("customizeToggle");
const customizePanel = document.getElementById("customizePanel");
const customizePicker = document.getElementById("customizePicker");
const customizeContainer = document.getElementById("customizeContainer");
// --- State ---
let colors = ["Red","Blue","Green","Yellow","Purple","Orange","Pink","Black","White","Cyan","Lime"];
let cart=[], selectedBracelet="", selectedPrice=0, selectedColors=[], pendingExtra=[];
let adminLoggedIn = false;
let ordersCache = [];
let currentLookup = "";
// --- Ensure Auth Persistence (so admin stays logged in across reloads) ---
setPersistence(auth, browserLocalPersistence).catch(e=>{
  console.warn("setPersistence failed:", e);
});
/* -----------------------------
   NEW: generate or load a clientId in localStorage (identifies this browser/user)
   so orders created from this browser are marked and shown under "My Orders"
   without needing a page reload.
   ----------------------------- */
let clientId = localStorage.getItem('unbeadable_clientId');
if (!clientId) {
  clientId = 'c_' + Math.random().toString(36).slice(2,12);
  localStorage.setItem('unbeadable_clientId', clientId);
}
/* --- PREFILL NAME from localStorage so My Orders shows after reload --- */
const storedName = localStorage.getItem('unbeadable_name');
if (storedName) {
  nameInput.value = storedName;
}
// --- RATINGS: per-browser user id so users can update their rating ---
let userRatingId = localStorage.getItem('unbeadable_uid');
if(!userRatingId){
  userRatingId = 'u_' + Math.random().toString(36).slice(2,10);
  localStorage.setItem('unbeadable_uid', userRatingId);
}
// --- Ratings UI init from localStorage (if present) ---
const savedRating = localStorage.getItem("rating");
if (savedRating) {
  stars.forEach(s => { if(s.dataset.star <= savedRating) s.classList.add("active"); });
}
/* ----------------------------
   LOCAL ORDER MIRROR (ADDITIVE)
   - local orders saved to localStorage so My Orders displays orders placed
     from this browser immediately, even if Firestore read is restricted.
   - stored under key 'unbeadable_localOrders'
   ---------------------------- */
const LS_LOCAL_ORDERS = 'unbeadable_localOrders';
function readLocalOrders(){
  try { const raw = localStorage.getItem(LS_LOCAL_ORDERS); return raw ? JSON.parse(raw) : []; } catch(e){ return []; }
}
function writeLocalOrders(arr){
  try { localStorage.setItem(LS_LOCAL_ORDERS, JSON.stringify(arr)); } catch(e){ console.warn("writeLocalOrders failed", e); }
}
function addLocalOrder(order){
  try {
    const arr = readLocalOrders();
    if(order.orderCode && arr.some(o => o.orderCode === order.orderCode)) return;
    arr.unshift(order);
    writeLocalOrders(arr);
    renderLocalOrders();
    updateMyOrdersBadge();
  } catch(e){ console.warn("addLocalOrder failed", e); }
}
function renderLocalOrders(){
  try {
    if(!myOrdersDiv) return;
    let container = document.getElementById('localOrdersContainer');
    if(!container){
      container = document.createElement('div');
      container.id = 'localOrdersContainer';
      myOrdersDiv.parentNode.insertBefore(container, myOrdersDiv);
    }
    const local = readLocalOrders();
    if(local.length === 0){
      container.innerHTML = '';
      return;
    }
    let html = '<div style="margin-bottom:6px;"><strong>Your device orders</strong></div>';
    local.forEach(o=>{
      const t = o.time ? (new Date(o.time)).toLocaleString() : "";
      const totalPrice = (Array.isArray(o.cart) ? o.cart.reduce((a,b)=>a+(b.price||0),0) : 0).toFixed(2);
      const itemsList = Array.isArray(o.cart) ? o.cart.map(c=>`${c.name} (${c.colors ? c.colors.join(", ") : ""})`).join("<br>") : "";
      const oc = o.orderCode ? ` <small style="color:#374151">[${o.orderCode}]</small>` : "";
      html += `<div><p><b>${o.name || "Unknown"}</b> <small>(You)</small>${oc} - $${totalPrice} - Tip: $${o.tip||0} - <span class="${o.status==='done'?'doneBadge': o.status==='complete'?'doneBadge':'pendingBadge'}">${o.status||'pending'}</span><br>${itemsList}<br><small>${t}</small></p><hr></div>`;
    });
    container.innerHTML = html;
  } catch(e){ console.warn("renderLocalOrders failed", e); }
}
/* ----------------------------
   STAR CLICK: allow changes, save locally, push to Firestore ratings collection, update UI instantly
   ---------------------------- */
stars.forEach(star => {
  star.onclick = async () => {
    const rating = Number(star.dataset.star);
    stars.forEach(s => s.classList.remove("active"));
    stars.forEach(s => { if(Number(s.dataset.star) <= rating) s.classList.add("active"); });
    localStorage.setItem("rating", String(rating));
    try {
      await setDoc(doc(db, "ratings", userRatingId), {
        rating: rating,
        userName: nameInput.value ? nameInput.value.trim() : null,
        time: new Date()
      });
      console.log("Saved rating:", rating);
    } catch (e) {
      console.error("Failed to save rating to Firestore:", e);
    }
  };
});
/* ----------------------------
   Shop Products
   ---------------------------- */
const products = [
{name:"Normal Bracelet",price:0.75},{name:"Triple Normal",price:0.95},{name:"Fishtail",price:0.85},{name:"Inverted Fishtail",price:0.95},
{name:"Starburst",price:1.00},{name:"Honeycomb",price:1.50},{name:"Dragon Scale",price:1.75},{name:"Ladder",price:1.85},
{name:"Flower Power",price:1.00},{name:"Tropico",price:1.00},{name:"Name bracelet",price:0.85},{name:"Taffy Twist",price:1.00},
{name:"Random Color Bracelet",price:1.25},{name:"Mystery Bag Bracelet",price:1.50}
];
// --- ADDED: Bracelet images map (uses Imgur links you provided) ---
const braceletImages = {
  "Normal Bracelet": "https://i.imgur.com/4ru5gNK.jpeg",
  "Triple Normal": "https://i.imgur.com/U6lh2t2.jpeg",
  "Fishtail": "https://i.imgur.com/3KomDoK.jpeg",
  "Inverted Fishtail": "https://i.imgur.com/Jh776rQ.jpeg",
  "Starburst": "https://i.imgur.com/OsrgrM3.jpeg",
  "Honeycomb": "https://i.imgur.com/4qKTebb.jpeg",
  "Dragon Scale": "https://i.imgur.com/4Hgfu1H.jpeg",
  "Ladder": "https://i.imgur.com/4sIn0aa.jpeg",
  "Flower Power": "https://i.imgur.com/pEr93P0.jpeg",
  "Tropico": "https://i.imgur.com/jjA1q4V.jpeg",
  "Name bracelet": "https://i.imgur.com/W0z2404.jpeg",
  "Taffy Twist": "https://i.imgur.com/GTRQVGH.jpeg",
  "Random Color Bracelet": "https://i.imgur.com/EncMExO.jpeg",
  "Mystery Bag Bracelet": "https://i.imgur.com/EncMExO.jpeg"
};
// --- Color Picker & Cart functions ---
function renderColors(){
  const picker = document.getElementById("colorPicker");
  picker.innerHTML="";
  colors.forEach(c=>{
    const d = document.createElement("div");
    d.className="color-option"; d.style.background=c.toLowerCase();
    d.onclick = ()=>{
      if(selectedColors.includes(c)) return;
      if(selectedColors.length<5){ selectedColors.push(c); d.classList.add("selected"); }
      else { pendingExtra.push(c); extraModal.style.display="flex"; }
    };
    picker.appendChild(d);
  });
}
function openModal(n,p){ selectedBracelet=n; selectedPrice=p; selectedColors=[]; pendingExtra=[]; renderColors(); colorModal.style.display="flex"; }
closeModal.onclick = ()=> colorModal.style.display="none";
extraYes.onclick = ()=> { selectedColors.push(...pendingExtra); selectedPrice += 0.25 * pendingExtra.length; pendingExtra=[]; renderCart(); extraModal.style.display="none"; };
extraNo.onclick = ()=> { pendingExtra=[]; extraModal.style.display="none"; };
confirmColors.onclick = ()=>{ if(!selectedColors.length) return alert("Pick colors"); cart.push({name:selectedBracelet, price:selectedPrice, colors:[...selectedColors]}); renderCart(); colorModal.style.display="none"; };
function renderCart(){
  items.innerHTML="";
  let t=0;
  cart.forEach((x,i)=>{
    items.innerHTML+=`<p><b>${x.name}</b> - ${x.price.toFixed(2)}<br>${x.colors.join(", ")}<button class="deleteBtn" onclick="removeFromCart(${i})">Remove</button></p>`;
    t+=x.price;
  });
  total.innerText=t.toFixed(2);
}
window.removeFromCart = (i)=>{ cart.splice(i,1); renderCart(); };
// --- Add Products: include <img> above product name (images added, nothing removed) ---
products.forEach(p=>{
  const c = document.createElement("div"); c.className="card";
  const imgSrc = braceletImages[p.name] || "https://source.unsplash.com/400x400/?rainbow+loom+bracelet";
  c.innerHTML=`
    <img class="bracelet-img" src="${imgSrc}" alt="${p.name}">
    <h3>${p.name}</h3>
    <div class="price">${p.price.toFixed(2)}</div>
    <button>Add</button>
  `;
  c.querySelector("button").onclick = ()=>{
    if(p.name.includes("Random") || p.name.includes("Mystery")){
      selectedBracelet=p.name; selectedPrice=p.price; selectedColors=[];
      for(let i=0;i<5;i++){ selectedColors.push(colors[Math.floor(Math.random()*colors.length)]); }
      cart.push({name:selectedBracelet, price:selectedPrice, colors:[...selectedColors]}); renderCart();
      alert(`${p.name} added with 5 random colors!`);
    } else { openModal(p.name,p.price); }
  };
  shopGrid.appendChild(c);
});
/* ----------------------------
   Helper: generate short order code (ADDED)
   Format: ORD-xxxxx (5 chars from base36 timestamp+random)
   ---------------------------- */
function generateOrderCode(){
  const part = (Date.now().toString(36).slice(-5) + Math.random().toString(36).slice(2,6)).slice(0,6);
  return "ORD-" + part.toUpperCase();
}
/* ----------------------------
   Checkout & Tip: UPDATED to include clientId and orderCode so orders are tied to this browser instantly
   and the customer receives an order code they can use on another device/account to view the order (ADDED)
   Also mirrors the order locally (so My Orders shows it immediately).
   ---------------------------- */
checkout.onclick = ()=>{
  if(!nameInput.value || !cart.length) return alert("Missing info");
  tipModal.style.display="flex";
};
tipModal.querySelectorAll("button").forEach(b=>{
  b.onclick=async()=>{
    const tip = parseInt(b.dataset.tip);
    tipModal.style.display="none";
    const userName = nameInput.value.trim();
    if(!userName) return alert("Please enter your name!");
    localStorage.setItem('unbeadable_name', userName);
    const orderCode = generateOrderCode();
    const localOrder = {
      name: userName,
      cart: JSON.parse(JSON.stringify(cart)),
      status: "pending",
      rating: localStorage.getItem("rating") || null,
      tip: tip,
      time: new Date().toISOString(),
      clientId: clientId,
      orderCode: orderCode,
      contactEmail: null
    };
    try {
      const ref = await addDoc(collection(db,"orders"),{
        name: userName,
        cart,
        status:"pending",
        rating:localStorage.getItem("rating") || null,
        tip:tip,
        time:new Date(),
        clientId: clientId,
        orderCode: orderCode,
        contactEmail: null
      });
      addLocalOrder(localOrder);
      cart=[]; renderCart();
      try {
        await navigator.clipboard.writeText(orderCode);
        alert(`Order placed! Your order code: ${orderCode}\n(it was copied to your clipboard)`);
      } catch(e) {
        alert(`Order placed! Your order code: ${orderCode}\n(copy failed — please copy it manually)`);
      }
      renderOrdersFromCache();
      updateMyOrdersBadge();
    } catch(e) {
      console.error("Failed to place order:", e);
      addLocalOrder(localOrder);
      cart=[]; renderCart();
      alert("Order placed locally (server save failed). Your order code: " + orderCode);
      renderOrdersFromCache();
      updateMyOrdersBadge();
    }
  };
});
/* ----------------------------
   Admin login/logout (button toggles) ---------------------------- */
adminLogin.onclick = async ()=>{
  if (!adminLoggedIn) {
    try {
      await signInWithEmailAndPassword(auth, adminEmail.value, adminPass.value);
    } catch(e){ alert("Admin login failed"); }
  } else {
    try {
      await signOut(auth);
      adminLoggedIn = false;
      adminLogin.innerText = "Login";
      localStorage.removeItem('unbeadable_admin');
      alert("Admin logged out");
    } catch(e) { console.warn("signOut failed", e); }
  }
};
// --- onAuthStateChanged: keeps adminLoggedIn true when Firebase has a session ---
onAuthStateChanged(auth, (user) => {
  if (user) {
    adminLoggedIn = true;
    localStorage.setItem('unbeadable_admin', '1');
    adminLogin.innerText = "Logout";
    ordersDiv.scrollIntoView({behavior:"smooth", block:"center"});
    renderOrdersFromCache();
  } else {
    adminLoggedIn = false;
    localStorage.removeItem('unbeadable_admin');
    adminLogin.innerText = "Login";
    renderOrdersFromCache();
  }
});
/* ----------------------------
   helper to render using the cached snapshot docs (creates DOM so admin buttons can attach)
   MODIFIED: show orders that match the currentName OR match the clientId for this browser
   and ALSO look up by orderCode/name/email when currentLookup is set
   This ensures "My Orders" shows the orders *you* created from this browser instantly,
   and supports cross-device lookup via the order code (ADDED).
   Also renders local mirror orders by calling renderLocalOrders().
   ---------------------------- */
function renderOrdersFromCache(){
  ordersDiv.innerHTML = "";
  myOrdersDiv.innerHTML = "";
  const currentName = nameInput.value.trim();
  let myCount = 0;
  const lookup = (currentLookup || "").trim();
  ordersCache.forEach(docSnap=>{
    const data = docSnap.data();
    const id = docSnap.id;
    const totalPrice = (Array.isArray(data.cart) ? data.cart.reduce((a,b)=>a+(b.price||0),0) : 0).toFixed(2);
    const itemsList = Array.isArray(data.cart) ? data.cart.map(c=>`${c.name} (${c.colors ? c.colors.join(", ") : ""})`).join("<br>") : "";
    const time = data.time && data.time.toDate ? data.time.toDate().toLocaleString() : (data.time && data.time.seconds ? new Date(data.time.seconds*1000).toLocaleString() : "");
    const wrapper = document.createElement("div");
    const oc = data.orderCode ? ` <small style="color:#374151">[${data.orderCode}]</small>` : "";
    wrapper.innerHTML = `<p><b>${data.name || "Unknown"}</b>${oc} - ${totalPrice} - Tip: ${data.tip || 0} - <span class="${data.status==='done'?'doneBadge':'pendingBadge'}">${data.status}</span><br>${itemsList}<br><small>${time}</small></p><hr>`;
    if(adminLoggedIn){
      const btn = document.createElement("button");
      btn.className = "adminOrderBtn";
      btn.textContent = "Mark Complete";
      btn.addEventListener("click", async () => {
        try {
          await updateDoc(doc(db, "orders", id), { status: "complete" });
        } catch(err){
          console.error("Failed to update status:", err);
          alert("Failed to update order status.");
        }
      });
      wrapper.querySelector("p").appendChild(btn);
      const delBtn = document.createElement("button");
      delBtn.className = "adminOrderBtn";
      delBtn.style.background = "#ef4444";
      delBtn.textContent = "Delete";
      delBtn.addEventListener("click", () => {
        orderToDeleteId = id;
        deleteModal.style.display = "flex";
      });
      wrapper.querySelector("p").appendChild(delBtn);
      ordersDiv.appendChild(wrapper);
    }
    let showInMyOrders = false;
    if((currentName && data.name === currentName) || (data.clientId && data.clientId === clientId)) showInMyOrders = true;
    if(lookup){
      const l = lookup.toLowerCase();
      const matchesCode = data.orderCode && String(data.orderCode).toLowerCase() === l;
      const matchesName = data.name && String(data.name).toLowerCase() === l;
      const matchesEmail = data.contactEmail && String(data.contactEmail).toLowerCase() === l;
      const matchesId = id === lookup;
      if(matchesCode || matchesName || matchesEmail || matchesId) showInMyOrders = true;
      else showInMyOrders = false;
    }
    if(showInMyOrders){
      myCount++;
      const myWrap = document.createElement("div");
      const youBadge = (data.clientId && data.clientId === clientId) ? " <small>(You)</small>" : "";
      const oc2 = data.orderCode ? ` <small style="color:#374151">[${data.orderCode}]</small>` : "";
      myWrap.innerHTML = `<p><b>${data.name || "Unknown"}</b>${youBadge}${oc2} - ${totalPrice} - Tip: ${data.tip || 0} - <span class="${data.status==='done'?'doneBadge': data.status==='complete'?'doneBadge':'pendingBadge'}">${data.status}</span><br>${itemsList}<br><small>${time}</small></p><hr>`;
      myOrdersDiv.appendChild(myWrap);
    }
  });
  renderLocalOrders();
  updateMyOrdersBadge(myCount);
}
/* ----------------------------
   updateMyOrdersBadge: sets the badge and animates briefly when increased
   Combines Firestore count (passed in) with local mirror count for a total.
   ---------------------------- */
function updateMyOrdersBadge(count){
  const localCount = readLocalOrders().length || 0;
  if(typeof count === 'undefined'){
    const currentName = nameInput.value.trim();
    count = ordersCache.reduce((acc,docSnap)=>{
      const data = docSnap.data();
      if((currentName && data.name === currentName) || (data.clientId && data.clientId === clientId)) return acc+1;
      return acc;
    }, 0);
  }
  const totalCount = localCount + Number(count || 0);
  const display = totalCount > 99 ? '99+' : String(totalCount);
  if(myOrdersBadge){
    const prev = myOrdersBadge.innerText;
    myOrdersBadge.innerText = display;
    if(Number(totalCount) > Number(prev || 0)){
      myOrdersBadge.animate([{ transform: 'scale(1)' }, { transform: 'scale(1.18)' }, { transform: 'scale(1)' }], { duration: 300, easing: 'ease-out' });
    }
    myOrdersBadge.style.display = (totalCount === 0 ? 'none' : 'inline-flex');
  }
}
myOrdersBadge.style.display = 'none';
/* ----------------------------
   Real-time Orders: cache docs and render via renderOrdersFromCache
   We also update the badge on snapshot so changes appear instantly
   ---------------------------- */
onSnapshot(collection(db,"orders"), snapshot=>{
  ordersCache = [];
  snapshot.forEach(doc => ordersCache.push(doc));
  renderOrdersFromCache();
  updateMyOrdersBadge();
});
/* ----------------------------
   Delete modal handlers
   ---------------------------- */
deleteNo.onclick = () => {
  orderToDeleteId = null;
  deleteModal.style.display = "none";
};
deleteYes.onclick = async () => {
  if (!orderToDeleteId) return;
  try {
    await deleteDoc(doc(db, "orders", orderToDeleteId));
    orderToDeleteId = null;
    deleteModal.style.display = "none";
  } catch(err) {
    console.error("Delete failed:", err);
    alert("Failed to delete order.");
  }
};
// --- Toggle Panels ---
myOrdersBtn.onclick = ()=>{
  const isOpen = myOrdersPanel.style.display === "block";
  myOrdersPanel.style.display = isOpen ? "none" : "block";
  myOrdersBtn.setAttribute('aria-expanded', String(!isOpen));
  myOrdersPanel.setAttribute('aria-hidden', String(isOpen));
  setTimeout(()=>{ updateCustomizePosition(); renderOrdersFromCache(); }, 45);
};
/* ----------------------------
   RATINGS AGGREGATION: AppStore-like bar graph (live)
   ---------------------------- */
const ratingBarsContainer = document.getElementById('ratingBars');
function buildEmptyBars(){
  ratingBarsContainer.innerHTML = '';
  for(let star=5; star>=1; star--){
    const row = document.createElement('div');
    row.className = 'barContainer';
    row.innerHTML = `<div class="barLabel">${star}</div><div class="barWrap"><div class="barBg"><div class="bar" data-star="${star}" style="width:0%"></div></div><div class="barCount" data-count="${star}">0</div></div>`;
    ratingBarsContainer.appendChild(row);
  }
}
buildEmptyBars();
onSnapshot(collection(db,"ratings"), snapshot=>{
  const counts = [0,0,0,0,0];
  let sum=0, total=0;
  snapshot.forEach(docSnap=>{
    const d = docSnap.data();
    const r = Number(d.rating) || 0;
    if(r>=1 && r<=5){
      counts[r-1] += 1;
      sum += r;
      total += 1;
    }
  });
  const avg = total ? (sum/total).toFixed(2) : "0.00";
  document.getElementById('avgRating').innerText = `Average: ${avg} ★`;
  const bars = ratingBarsContainer.querySelectorAll('.bar');
  bars.forEach(barEl => {
    const star = Number(barEl.getAttribute('data-star'));
    const c = counts[star-1] || 0;
    const pct = total ? (c/total*100) : 0;
    barEl.style.width = pct + '%';
    const parent = barEl.closest('.barWrap');
    if(parent){
      const countEl = parent.querySelector('.barCount');
      if(countEl) countEl.innerText = c;
    }
  });
});
/* ----------------------------
   LIVE: Listen to this user's rating doc so their star UI updates if changed from another browser/device.
   ---------------------------- */
onSnapshot(doc(db, "ratings", userRatingId), docSnap => {
  if(!docSnap.exists) return;
  const d = docSnap.data();
  const r = Number(d.rating) || 0;
  stars.forEach(s => s.classList.remove("active"));
  stars.forEach(s => { if(Number(s.dataset.star) <= r) s.classList.add("active"); });
  localStorage.setItem("rating", String(r));
});
/* ----------------------------
   Ratings toggle button
   ---------------------------- */
toggleRatingGraph.onclick = async ()=>{
  const panel = document.getElementById("ratingGraphPanel");
  panel.style.display = panel.style.display==="block"?"none":"block";
};
/* ----------------------------
   CUSTOMIZE PANEL LOGIC (ADDED)
   ---------------------------- */
const customizeColors = [
  "#7c3aed", "#ef4444", "#10b981", "#f59e0b", "#0ea5e9",
  "#ec4899", "#6366f1", "#f97316", "#14b8a6", "#111827"
];
function shadeHex(hex, percent){
  const num = parseInt(hex.slice(1),16);
  let r = (num >> 16) + Math.round(2.55 * percent);
  let g = (num >> 8 & 0x00FF) + Math.round(2.55 * percent);
  let b = (num & 0x0000FF) + Math.round(2.55 * percent);
  r = Math.max(0, Math.min(255, r));
  g = Math.max(0, Math.min(255, g));
  b = Math.max(0, Math.min(255, b));
  return "#" + ( (1 << 24) + (r << 16) + (g << 8) + b ).toString(16).slice(1);
}
function buildCustomizePicker(){
  customizePicker.innerHTML = "";
  customizeColors.forEach(color => {
    const d = document.createElement('div');
    d.className = "color-option";
    d.style.background = color;
    d.title = color;
    d.onclick = () => {
      applyAccentColor(color);
      customizePicker.querySelectorAll('.color-option').forEach(e=>e.classList.remove('selected'));
      d.classList.add('selected');
    };
    customizePicker.appendChild(d);
  });
}
function applyAccentColor(hex){
  localStorage.setItem('unbeadable_accent', hex);
  const hover = shadeHex(hex, -10);
  document.documentElement.style.setProperty('--accent', hex);
  document.documentElement.style.setProperty('--accent-hover', hover);
}
const savedAccent = localStorage.getItem('unbeadable_accent');
if(savedAccent){
  applyAccentColor(savedAccent);
}
customizeToggle.onclick = () => {
  customizePanel.style.display = customizePanel.style.display === "block" ? "none" : "block";
  if(customizePicker.children.length === 0) {
    buildCustomizePicker();
    const saved = localStorage.getItem('unbeadable_accent');
    if(saved){
      customizePicker.querySelectorAll('.color-option').forEach(el=>{
        if(el.style.background.toLowerCase() === saved.toLowerCase()) el.classList.add('selected');
      });
    }
  }
};
buildCustomizePicker();
/* ----------------------------
   DYNAMIC POSITIONING: place customizeContainer exactly 3px under myOrdersBtn
   ---------------------------- */
function updateCustomizePosition(){
  if(!customizeContainer || !myOrdersBtn) return;
  const panelVisible = window.getComputedStyle(myOrdersPanel).display !== 'none';
  let topPx;
  if(panelVisible){
    const rect = myOrdersPanel.getBoundingClientRect();
    topPx = Math.round(rect.bottom + 3);
  } else {
    const btnRect = myOrdersBtn.getBoundingClientRect();
    topPx = Math.round(btnRect.bottom + 3);
  }
  customizeContainer.style.top = `${topPx}px`;
  const viewportHeight = window.innerHeight;
  const containerRect = customizeContainer.getBoundingClientRect();
  if(containerRect.bottom > viewportHeight - 8){
    const overflow = containerRect.bottom - (viewportHeight - 8);
    customizeContainer.style.top = `${Math.max(8, topPx - overflow)}px`;
  }
}
window.addEventListener('load', ()=>{
  updateCustomizePosition();
  const saved = localStorage.getItem('unbeadable_accent');
  if(saved && customizePicker.children.length){
    customizePicker.querySelectorAll('.color-option').forEach(el=>{
      if(el.style.background.toLowerCase() === saved.toLowerCase()) el.classList.add('selected');
    });
  }
  renderLocalOrders();
  updateMyOrdersBadge();
});
window.addEventListener('resize', updateCustomizePosition);
window.addEventListener('scroll', updateCustomizePosition);
myOrdersBtn.addEventListener('click', ()=> {
  setTimeout(updateCustomizePosition, 45);
});
/* ----------------------------
   Ensure My Orders updates instantly when the name input changes
   ---------------------------- */
nameInput.addEventListener('input', () => {
  localStorage.setItem('unbeadable_name', nameInput.value.trim());
  renderOrdersFromCache();
  updateMyOrdersBadge();
});
/* ----------------------------
   Lookup controls (ADDED)
   ---------------------------- */
lookupBtn.addEventListener('click', () => {
  currentLookup = lookupInput.value.trim();
  renderOrdersFromCache();
  updateMyOrdersBadge();
});
clearLookupBtn.addEventListener('click', () => {
  currentLookup = "";
  lookupInput.value = "";
  renderOrdersFromCache();
  updateMyOrdersBadge();
});
</script>
<script type="module">
const btn = document.getElementById('myOrdersBtn');
const panel = document.getElementById('myOrdersPanel');
const customize = document.getElementById('customizeContainer');
function placeCustomizeUnderPanelOrButton() {
  setTimeout(() => {
    if (!btn || !panel || !customize) return;
    const panelVisible = window.getComputedStyle(panel).display !== 'none';
    if (panelVisible) {
      const rect = panel.getBoundingClientRect();
      customize.style.top = (Math.round(rect.bottom) + 3) + 'px';
    } else {
      const btnRect = btn.getBoundingClientRect();
      customize.style.top = (Math.round(btnRect.bottom) + 3) + 'px';
    }
    const viewportHeight = window.innerHeight;
    const cRect = customize.getBoundingClientRect();
    if (cRect.bottom > viewportHeight - 8) {
      const overflow = cRect.bottom - (viewportHeight - 8);
      customize.style.top = Math.max(8, parseInt(customize.style.top || 0, 10) - overflow) + 'px';
    }
  }, 45);
}
btn.addEventListener('click', placeCustomizeUnderPanelOrButton);
window.addEventListener('load', placeCustomizeUnderPanelOrButton);
window.addEventListener('resize', placeCustomizeUnderPanelOrButton);
window.addEventListener('scroll', placeCustomizeUnderPanelOrButton);
</script>
<script type="module">
import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, query, where, getDocs, getDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
const firebaseConfig = {
  apiKey: "AIzaSyAabIc-81hx89cRxMxiDuIYV7AXvc7Gdto",
  authDomain: "unbeadable-2e4f1.firebaseapp.com",
  projectId: "unbeadable-2e4f1",
  appId: "1:904715339138:web:0879a7b347805691d53b9b"
};
let app2;
if (getApps && getApps().length) {
  app2 = getApps()[0];
} else {
  app2 = initializeApp(firebaseConfig);
}
const db2 = getFirestore(app2);
try {
  const header = document.querySelector('header');
  if (header) {
    header.innerHTML = `<img src="https://i.imgur.com/iU6QnEf.png" alt="Unbeadable" style="max-width:320px; width:100%; height:auto; display:block; margin:0 auto;">`;
  }
} catch(e){
  console.warn("Header image replacement failed:", e);
}
function buildOrderHTML(id, data, highlightYou=false){
  const totalPrice = (Array.isArray(data.cart) ? data.cart.reduce((a,b)=>a+(b.price||0),0) : 0).toFixed(2);
  const itemsList = Array.isArray(data.cart) ? data.cart.map(c=>`${c.name} (${c.colors ? c.colors.join(", ") : ""})`).join("<br>") : "";
  const time = data.time && data.time.toDate ? data.time.toDate().toLocaleString() : (data.time && data.time.seconds ? new Date(data.time.seconds*1000).toLocaleString() : "");
  const oc = data.orderCode ? ` <small style="color:#374151">[${data.orderCode}]</small>` : "";
  const youBadge = highlightYou ? " <small>(You)</small>" : "";
  return `<div><p><b>${data.name || "Unknown"}</b>${youBadge}${oc} - ${totalPrice} - Tip: ${data.tip || 0} - <span class="${data.status==='done'?'doneBadge': data.status==='complete'?'doneBadge':'pendingBadge'}">${data.status}</span><br>${itemsList}<br><small>${time}</small></p><hr></div>`;
}
async function performLookupServer(lookup){
  const field = (lookup || "").trim();
  const outDiv = document.getElementById('myOrders');
  const badge = document.getElementById('myOrdersBadge');
  if(!field){
    outDiv.innerHTML = '<p>Enter an order code, name, or email to look up.</p>';
    badge.innerText = '0';
    badge.style.display = 'none';
    return;
  }
  outDiv.innerHTML = '<p>Searching...</p>';
  const results = new Map();
  try {
    const q1 = query(collection(db2,'orders'), where('orderCode','==', field));
    const s1 = await getDocs(q1);
    s1.forEach(d => results.set(d.id, d));
  } catch(e){ console.warn("orderCode query failed:", e); }
  try {
    const q2 = query(collection(db2,'orders'), where('name','==', field));
    const s2 = await getDocs(q2);
    s2.forEach(d => results.set(d.id, d));
  } catch(e){ console.warn("name query failed:", e); }
  try {
    const q3 = query(collection(db2,'orders'), where('contactEmail','==', field));
    const s3 = await getDocs(q3);
    s3.forEach(d => results.set(d.id, d));
  } catch(e){ console.warn("email query failed:", e); }
  try {
    const docRef = doc(db2,'orders', field);
    const dd = await getDoc(docRef);
    if(dd.exists()) results.set(dd.id, dd);
  } catch(e){}
  if(results.size === 0){
    outDiv.innerHTML = `<p>No orders found for "<b>${field}</b>".</p>`;
    if(badge){ badge.innerText = '0'; badge.style.display = 'none'; }
    return;
  }
  let html = '';
  results.forEach(docSnap => {
    const d = docSnap.data();
    const highlight = (d.clientId && d.clientId === localStorage.getItem('unbeadable_clientId'));
    html += buildOrderHTML(docSnap.id, d, highlight);
  });
  outDiv.innerHTML = html;
  if(badge){
    const cnt = results.size;
    badge.innerText = cnt > 99 ? '99+' : String(cnt);
    badge.style.display = cnt ? 'inline-flex' : 'none';
    badge.animate([{ transform: 'scale(1)' }, { transform: 'scale(1.12)' }, { transform: 'scale(1)' }], { duration: 280, easing: 'ease-out' });
  }
}
const findButton = document.getElementById('lookupBtn');
if(findButton){
  findButton.addEventListener('click', async () => {
    const lookupVal = (document.getElementById('lookupInput') || {}).value || '';
    try {
      await performLookupServer(lookupVal.trim());
    } catch(e){
      console.error("Lookup failed:", e);
    }
  });
}
const lookupInputEl = document.getElementById('lookupInput');
if(lookupInputEl){
  lookupInputEl.addEventListener('keydown', async (ev) => {
    if(ev.key === 'Enter'){
      ev.preventDefault();
      document.getElementById('lookupBtn').click();
    }
  });
}
const clearBtn = document.getElementById('clearLookupBtn');
if(clearBtn){
  clearBtn.addEventListener('click', () => {
    const inp = document.getElementById('lookupInput');
    if(inp) inp.value = '';
    document.getElementById('myOrders').innerHTML = '<p>Lookup cleared. Your orders (if any) are shown above by name or by client browser.</p>';
    const badge = document.getElementById('myOrdersBadge');
    if(badge) badge.style.display = badge.innerText === '0' ? 'none' : 'inline-flex';
  });
}
</script>
<!-- ===== ADD-ON (RELIABLE): Cart button + Dragon Scale extra-width control (non-destructive) ===== -->
<style>
  /* Cart floating button */
  #goCartBtn {
    position: fixed;
    bottom: 18px;
    right: 18px;
    z-index: 2200;
    background: var(--accent);
    color: white;
    border: none;
    border-radius: 12px;
    padding: 12px 16px;
    box-shadow: 0 8px 22px rgba(0,0,0,0.18);
    font-weight: bold;
    cursor: pointer;
    display: inline-flex;
    gap: 8px;
    align-items:center;
    touch-action: manipulation;
  }
  #goCartBtn:active { transform: translateY(1px); }
  #goCartBtnBadge {
    min-width:20px; height:20px; padding:0 6px; border-radius:999px;
    display:inline-flex; align-items:center; justify-content:center;
    background:#ef4444; color:white; font-weight:bold; font-size:12px;
  }

  /* Dragon width control inside modal */
  #dragonWidthControl {
    margin-top:12px;
    display:flex;
    gap:8px;
    align-items:center;
    justify-content:center;
    flex-wrap:wrap;
  }
  #dragonWidthControl .dw-btn {
    padding:8px 10px;
    border-radius:8px;
    background:var(--accent);
    color:white;
    border:none;
    min-width:44px;
    font-weight:bold;
    touch-action: manipulation;
  }
  #dragonWidthControl .dw-count {
    min-width:48px;
    text-align:center;
    font-weight:bold;
    font-size:16px;
    padding:6px 8px;
    border-radius:8px;
    border:1px solid #e5e7eb;
    background:#fff;
  }
  #dragonWidthControl .dw-info { font-size:13px; color:#374151; }
</style>

<script>
(function(){
  // 25 cents per width (exact value you requested)
  const EXTRA_PER_WIDTH = 0.25;
  const MAX_WIDTH = 5;

  // create floating cart button
  const goBtn = document.createElement('button');
  goBtn.id = 'goCartBtn';
  goBtn.innerHTML = 'Cart <span id="goCartBtnBadge">0</span>';
  document.body.appendChild(goBtn);

  function updateCartBadge(){
    const badge = document.getElementById('goCartBtnBadge');
    if(!badge) return;
    const count = (Array.isArray(window.cart) ? window.cart.length : 0);
    badge.innerText = count > 99 ? '99+' : String(count);
    badge.style.display = (count === 0 ? 'none' : 'inline-flex');
  }

  goBtn.addEventListener('click', ()=>{
    const cartEl = document.getElementById('cart');
    if(cartEl){
      cartEl.scrollIntoView({behavior:'smooth', block:'start'});
      cartEl.animate([{ boxShadow: '0 0 0 rgba(0,0,0,0)' }, { boxShadow: '0 8px 30px rgba(124,58,237,0.12)' }, { boxShadow: '0 0 0 rgba(0,0,0,0)' }], { duration: 700 });
    }
  });

  // build Dragon width control DOM
  function createDragonWidthControl(){
    const wrapper = document.createElement('div');
    wrapper.id = 'dragonWidthControl';
    wrapper.innerHTML = `
      <div class="dw-info">Dragon Scale extra width (max ${MAX_WIDTH}). Each + adds $${EXTRA_PER_WIDTH.toFixed(2)}.</div>
      <div style="display:flex; gap:8px; align-items:center;">
        <button type="button" class="dw-btn" id="dwMinus" aria-label="Decrease width">−</button>
        <div class="dw-count" id="dwCount">0</div>
        <button type="button" class="dw-btn" id="dwPlus" aria-label="Increase width">+</button>
      </div>
    `;
    return wrapper;
  }

  // helper: attach dragon control to modal content (defensive)
  function attachDragonControlToModal(){
    const content = document.querySelector('#colorModal .modal-content');
    if(!content) return null;
    // remove any leftover
    const prev = document.getElementById('dragonWidthControl');
    if(prev) prev.remove();
    const ctl = createDragonWidthControl();
    content.appendChild(ctl);
    return ctl;
  }

  // Keep an ephemeral dragonWidth while modal open
  let dragonWidth = 0;

  // Observe clicks on shop grid Add buttons (works regardless of module scope)
  const shopGrid = document.getElementById('shopGrid');
  if(shopGrid){
    shopGrid.addEventListener('click', (ev)=>{
      // find clicked Add button inside a product card
      const btn = ev.target.closest('button');
      if(!btn) return;
      // find product name within the same .card
      const card = btn.closest('.card');
      if(!card) return;
      const h3 = card.querySelector('h3');
      const pname = h3 ? h3.textContent.trim() : '';
      // if Dragon Scale, wait briefly for the modal to open and then attach control
      if(pname === 'Dragon Scale'){
        setTimeout(()=>{
          dragonWidth = 0;
          const ctl = attachDragonControlToModal();
          if(!ctl) return;
          const dwCount = document.getElementById('dwCount');
          const dwPlus = document.getElementById('dwPlus');
          const dwMinus = document.getElementById('dwMinus');
          function renderCount(){ if(dwCount) dwCount.innerText = String(dragonWidth); }
          dwPlus.onclick = ()=> { if(dragonWidth < MAX_WIDTH) { dragonWidth++; renderCount(); } };
          dwMinus.onclick = ()=> { if(dragonWidth > 0) { dragonWidth--; renderCount(); } };
          // touch feedback
          [dwPlus, dwMinus].forEach(b=>{
            b.addEventListener('touchstart', (e)=>{ e.preventDefault(); b.classList.add('active-touch'); }, {passive:false});
            b.addEventListener('touchend', ()=> b.classList.remove('active-touch'), {passive:true});
          });
          renderCount();
        }, 60);
      }
    }, {passive:true});
  }

  // Also support the case where code elsewhere calls openModal: detect modal opening by observing colorModal display
  const colorModal = document.getElementById('colorModal');
  if(colorModal){
    // MutationObserver to detect when modal is shown
    const obs = new MutationObserver((mutations)=>{
      mutations.forEach(m=>{
        if(m.attributeName === 'style'){
          const style = colorModal.style;
          const isVisible = style.display !== '' && style.display !== 'none';
          if(isVisible){
            // check selectedBracelet if available globally; fallback to checking modal content heading
            const nameFromGlobal = (typeof window.selectedBracelet !== 'undefined') ? window.selectedBracelet : null;
            // If global says Dragon Scale OR modal content suggests it's Dragon Scale, attach control
            if(nameFromGlobal === 'Dragon Scale'){
              dragonWidth = 0;
              const ctl = attachDragonControlToModal();
              if(!ctl) return;
              const dwCount = document.getElementById('dwCount');
              const dwPlus = document.getElementById('dwPlus');
              const dwMinus = document.getElementById('dwMinus');
              function renderCount(){ if(dwCount) dwCount.innerText = String(dragonWidth); }
              dwPlus.onclick = ()=> { if(dragonWidth < MAX_WIDTH) { dragonWidth++; renderCount(); } };
              dwMinus.onclick = ()=> { if(dragonWidth > 0) { dragonWidth--; renderCount(); } };
              [dwPlus, dwMinus].forEach(b=>{
                b.addEventListener('touchstart', (e)=>{ e.preventDefault(); b.classList.add('active-touch'); }, {passive:false});
                b.addEventListener('touchend', ()=> b.classList.remove('active-touch'), {passive:true});
              });
              renderCount();
            } else {
              // try to read bracelet name from modal DOM (if you show name there)
              // no-op otherwise
            }
          } else {
            // modal hidden -> cleanup
            dragonWidth = 0;
            const prev = document.getElementById('dragonWidthControl');
            if(prev) prev.remove();
          }
        }
      });
    });
    obs.observe(colorModal, { attributes: true, attributeFilter: ['style'] });
  }

  // Wrap confirmColors behavior by attaching our own handler to the DOM element.
  const confirmBtn = document.getElementById('confirmColors');
  if(confirmBtn){
    // keep original handler if present
    const prevHandler = confirmBtn.onclick;
    confirmBtn.onclick = function(e){
      // if ephemeral selectedBracelet equals Dragon Scale (try global var), handle width addition
      const currentName = (typeof window.selectedBracelet !== 'undefined') ? window.selectedBracelet : null;
      if(currentName === 'Dragon Scale'){
        // try to get selectedColors from global variable; fallback to reading color picker selections in DOM
        // we will prefer the global 'selectedColors' if it exists
        const selColors = (typeof window.selectedColors !== 'undefined') ? window.selectedColors : Array.from(document.querySelectorAll('#colorPicker .selected')).map(x=>{
          // attempt to infer color name from style.background (best-effort)
          return x.style.background || '';
        }).filter(Boolean);
        if(!selColors || selColors.length === 0){ alert('Pick colors'); return; }
        const basePrice = (typeof window.selectedPrice === 'number') ? window.selectedPrice : Number((document.querySelector('#colorModal') || {}).dataset?.price || 0);
        const extra = (Number(dragonWidth) || 0) * EXTRA_PER_WIDTH;
        const finalPrice = Number((basePrice || 0) + extra);
        // push the item into global cart (existing app uses global 'cart' array)
        if(!Array.isArray(window.cart)) window.cart = [];
        window.cart.push({
          name: 'Dragon Scale',
          price: Number(finalPrice),
          colors: selColors.slice(),
          dragonWidth: Number(dragonWidth)
        });
        // close modal and re-render cart using your existing renderCart function if present
        const modal = document.getElementById('colorModal'); if(modal) modal.style.display = 'none';
        if(typeof window.renderCart === 'function') window.renderCart();
        updateCartBadge();
        dragonWidth = 0;
        const ctl = document.getElementById('dragonWidthControl'); if(ctl) ctl.remove();
        return;
      }
      // otherwise call previous behavior (if any)
      if(typeof prevHandler === 'function'){
        try { prevHandler.call(confirmBtn, e); } catch(err){ console.warn('old confirmColors failed', err); }
      }
      // update badge in any case
      updateCartBadge();
    };
  }

  // Enhanced renderCart: show dragonWidth details. We'll replace global renderCart but keep fallback.
  const oldRenderCart = window.renderCart;
  window.renderCart = function(){
    try {
      const itemsEl = document.getElementById('items');
      const totalEl = document.getElementById('total');
      if(!itemsEl || !totalEl){
        if(typeof oldRenderCart === 'function') oldRenderCart();
        return;
      }
      itemsEl.innerHTML = '';
      let t = 0;
      (Array.isArray(window.cart) ? window.cart : []).forEach((x,i)=>{
        let widthHtml = '';
        if(x.name === 'Dragon Scale' && Number(x.dragonWidth) > 0){
          widthHtml = `<br><small>Extra width: ${x.dragonWidth} (adds $${(x.dragonWidth * EXTRA_PER_WIDTH).toFixed(2)})</small>`;
        }
        const colorsText = Array.isArray(x.colors) ? x.colors.join(", ") : "";
        itemsEl.innerHTML += `<p><b>${x.name}</b> - $${Number(x.price).toFixed(2)}<br>${colorsText}${widthHtml}<br><button class="deleteBtn" onclick="removeFromCart(${i})">Remove</button></p>`;
        t += Number(x.price) || 0;
      });
      totalEl.innerText = Number(t).toFixed(2);
      updateCartBadge();
    } catch(e){
      console.warn('enhanced renderCart error', e);
      if(typeof oldRenderCart === 'function') oldRenderCart();
    }
  };

  // Ensure removeFromCart updates badge (wrap existing)
  const oldRemove = window.removeFromCart;
  window.removeFromCart = function(i){
    if(typeof oldRemove === 'function'){
      try { oldRemove(i); } catch(err){ console.warn('old removeFromCart error', err); }
    } else {
      if(Array.isArray(window.cart)) window.cart.splice(i,1);
      if(typeof window.renderCart === 'function') window.renderCart();
    }
    updateCartBadge();
  };

  // initial sync
  document.addEventListener('DOMContentLoaded', updateCartBadge, {once:true});
  setTimeout(updateCartBadge, 300);
  // defensive periodic sync
  setInterval(updateCartBadge, 2500);

})();
</script>
</body>
</html>
