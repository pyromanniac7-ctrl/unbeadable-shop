<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Unbeadable Shop</title>
<style>
body { font-family: Arial,sans-serif; margin:0; background:#f5f7fb; }
header { background:#7c3aed; color:white; padding:30px; text-align:center; }
.container { max-width:1100px; margin:40px auto; padding:20px; }
.grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:20px; }
.card { background:white; padding:20px; border-radius:12px; box-shadow:0 8px 20px rgba(0,0,0,.08); }
.price { color:#7c3aed; font-weight:bold; }
button { margin-top:10px; width:100%; padding:10px; background:#7c3aed; color:white; border:none; border-radius:8px; cursor:pointer; }
button:hover { background:#6d28d9; }
#cart,#admin { background:white; padding:20px; border-radius:12px; margin-top:40px; }
.modal { position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; justify-content:center; align-items:center; z-index:2000; }
.modal-content { background:white; padding:20px; border-radius:12px; width:90%; max-width:400px; text-align:center; }
.color-picker { display:flex; flex-wrap:wrap; gap:10px; justify-content:center; }
.color-option { width:30px; height:30px; border-radius:50%; cursor:pointer; border:2px solid #ccc; }
.color-option.selected { border:3px solid #7c3aed; }
.deleteBtn { background:#dc2626; margin-top:8px; }
.deleteBtn:hover { background:#b91c1c; }
.doneBadge { color:green; font-weight:bold; }
.pendingBadge { color:#ca8a04; font-weight:bold; }
#myOrdersBtn { position:fixed; top:15px; right:15px; width:auto; padding:10px 14px; }
#myOrdersPanel { position:fixed; top:60px; right:15px; background:white; padding:15px; border-radius:12px; width:300px; max-height:70vh; overflow:auto; display:none; box-shadow:0 10px 25px rgba(0,0,0,.2); }
#ratingBox { position: fixed; top:15px; right:140px; background:white; padding:8px 12px; border-radius:12px; box-shadow:0 8px 20px rgba(0,0,0,.15); display:flex; align-items:center; gap:6px; z-index:1000; }
.star { font-size:20px; cursor:pointer; color:#d1d5db; }
.star.active { color:#facc15; }
.star.locked { cursor:default; }
#ratingGraphPanel { position: fixed; top:60px; right:280px; background:white; padding:12px; border-radius:12px; box-shadow:0 8px 20px rgba(0,0,0,.15); width:260px; z-index:1000; display:none; }
.barContainer { display:flex; align-items:center; gap:8px; margin-bottom:6px; }
.barLabel { width:24px; font-size:12px; text-align:right; }
.barWrap { display:flex; align-items:center; gap:8px; flex:1; }
.barBg { background:#e5e7eb; flex:1; height:12px; border-radius:6px; overflow:hidden; }
.bar { height:12px; border-radius:6px; width:0%; background:#7c3aed; transition: width 300ms ease; }
.barCount { font-size:12px; width:28px; text-align:left; }
.avgRating { text-align:center; font-weight:bold; margin-bottom:8px; font-size:14px; }
#toggleRatingGraph { position: fixed; top:15px; right:460px; padding:6px 8px; border-radius:10px; border:none; background:#7c3aed; color:white; cursor:pointer; z-index:1000; font-size:12px; }
#toggleRatingGraph:hover { background:#6d28d9; }
#tipModal .modal-content button, #extraModal .modal-content button { margin-top:8px; width:auto; padding:8px 12px; margin-right:6px; }
.adminOrderBtn { margin-left:8px; padding:6px 8px; border-radius:6px; background:#10b981; color:white; border:none; cursor:pointer; }
.adminOrderBtn:hover { background:#059669; }

/* small styles for delete modal buttons */
#deleteModal .modal-content button { margin:6px; padding:8px 12px; border-radius:6px; cursor:pointer; }
#deleteYes { background:#ef4444; color:white; border:none; }
#deleteNo { background:#6b7280; color:white; border:none; }

/* ADDED: round bracelet images above text (only added, nothing removed) */
.bracelet-img{
  width:120px;
  height:120px;
  object-fit:cover;
  border-radius:50%;
  display:block;
  margin:0 auto 10px;
  box-shadow:0 6px 18px rgba(0,0,0,0.12);
}

/* ADDED: customization overrides using CSS variables - these are additional rules (do not remove anything) */
:root {
  --accent: #7c3aed;
  --accent-hover: #6d28d9;
}

/* override only the GUI (not white areas) to reflect selected accent */
header { background: var(--accent) !important; }
.price { color: var(--accent) !important; }
button { background: var(--accent) !important; color: white !important; }
button:hover { background: var(--accent-hover) !important; }
#toggleRatingGraph { background: var(--accent) !important; }
#toggleRatingGraph:hover { background: var(--accent-hover) !important; }
.bar { background: var(--accent) !important; }
.adminOrderBtn { background: var(--accent) !important; }
.adminOrderBtn:hover { background: var(--accent-hover) !important; }

/* keep white backgrounds untouched - we only change accent colors */

/* New: container for Customize placed under My Orders (positioned but non-destructive) */
#customizeContainer{
  position: fixed;
  right: 15px;
  /* place just under the My Orders panel (which is top:60px; max-height:70vh) */
  top: calc(60px + 70vh + 10px);
  width: 300px;
  z-index: 1000;
  text-align:center;
  background: transparent; /* keep transparent so it doesn't block view */
}
#customizeContainer .inner {
  background: white;
  padding:10px;
  border-radius:10px;
  box-shadow:0 8px 20px rgba(0,0,0,0.12);
}
#customizeContainer p { margin:6px 0 8px 0; font-weight:bold; }
#customizeContainer .info { margin-top:8px; font-size:12px; color:#555; }

@media (max-width:700px){
  /* on small screens move customize to left so it doesn't overlap */
  #customizeContainer { right: 15px; top: auto; bottom: 15px; width: 260px; }
}
</style>
</head>
<body>

<div id="ratingBox">
  <span class="star" data-star="1">★</span>
  <span class="star" data-star="2">★</span>
  <span class="star" data-star="3">★</span>
  <span class="star" data-star="4">★</span>
  <span class="star" data-star="5">★</span>
</div>

<div id="ratingGraphPanel">
  <div class="avgRating" id="avgRating">Average: 0 ★</div>
  <div id="ratingBars">
    <!-- bars will be rendered here (5→1) -->
  </div>
</div>

<button id="toggleRatingGraph">Ratings</button>
<button id="myOrdersBtn">My Orders</button>
<div id="myOrdersPanel">
  <h3>My Orders</h3>
  <div id="myOrders"></div>

  <!-- NOTE: customize controls were moved OUTSIDE this element per your request -->
</div>

<!-- CUSTOMIZE CONTAINER placed UNDER the My Orders panel (moved here) -->
<div id="customizeContainer" aria-hidden="false">
  <div class="inner">
    <div style="margin-top:10px; text-align:center;">
      <button id="customizeToggle" style="width:auto; padding:8px 12px; border-radius:8px;">Customize</button>
    </div>

    <!-- Color picker panel for customization (hidden until Customize pressed) -->
    <div id="customizePanel" style="display:none; margin-top:12px;">
      <p>Pick an accent color (can't choose white)</p>
      <div id="customizePicker" class="color-picker"></div>
      <div class="info">Changes apply instantly. White is intentionally not available.</div>
    </div>
  </div>
</div>

<header>
<h1>Unbeadable</h1>
<p>Handmade Rubber Band Bracelets</p>
</header>

<div class="container">
<h2>Shop</h2>
<div class="grid" id="shopGrid"></div>

<div id="cart">
<h2>Cart</h2>
<div id="items"></div>
<p><strong>Total:</strong> $<span id="total">0.00</span></p>
<input id="name" placeholder="Your name">
<button id="checkout">Place Order</button>
</div>

<div id="admin">
<h2>Admin Panel</h2>
<input id="adminEmail" placeholder="Admin email">
<input id="adminPass" type="password" placeholder="Admin password">
<button id="adminLogin">Login</button>
<div id="orders"></div>
</div>
</div>

<div id="colorModal" class="modal">
<div class="modal-content">
<h3>Select up to 5 colors</h3>
<div class="color-picker" id="colorPicker"></div>
<button id="confirmColors">Add to Cart</button>
<button id="closeModal">Cancel</button>
</div>
</div>

<div id="tipModal" class="modal">
<div class="modal-content">
<h3>Would you like to leave a tip?</h3>
<button data-tip="1">$1</button>
<button data-tip="2">$2</button>
<button data-tip="3">$3</button>
<button data-tip="0">Skip</button>
</div>
</div>

<div id="extraModal" class="modal">
<div class="modal-content">
<p>You picked more than 5 colors. Each extra color costs $0.25. Add anyway?</p>
<button id="extraYes">Yes</button>
<button id="extraNo">No</button>
</div>
</div>

<!-- DELETE CONFIRMATION MODAL (added) -->
<div id="deleteModal" class="modal">
  <div class="modal-content">
    <p>Do you want to delete this order?</p>
    <button id="deleteYes">Yes</button>
    <button id="deleteNo">No</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

// --- Firebase Config ---
const firebaseConfig = {
  apiKey: "AIzaSyAabIc-81hx89cRxMxiDuIYV7AXvc7Gdto",
  authDomain: "unbeadable-2e4f1.firebaseapp.com",
  projectId: "unbeadable-2e4f1",
  appId: "1:904715339138:web:0879a7b347805691d53b9b"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// --- DOM Elements ---
const myOrdersBtn = document.getElementById("myOrdersBtn");
const myOrdersPanel = document.getElementById("myOrdersPanel");
const myOrdersDiv = document.getElementById("myOrders");
const stars = document.querySelectorAll(".star");
const shopGrid = document.getElementById("shopGrid");
const colorModal = document.getElementById("colorModal");
const closeModal = document.getElementById("closeModal");
const confirmColors = document.getElementById("confirmColors");
const checkout = document.getElementById("checkout");
const items = document.getElementById("items");
const total = document.getElementById("total");
const adminLogin = document.getElementById("adminLogin");
const adminEmail = document.getElementById("adminEmail");
const adminPass = document.getElementById("adminPass");
const ordersDiv = document.getElementById("orders");
const tipModal = document.getElementById("tipModal");
const extraModal = document.getElementById("extraModal");
const extraYes = document.getElementById("extraYes");
const extraNo = document.getElementById("extraNo");
const toggleRatingGraph = document.getElementById("toggleRatingGraph");
const nameInput = document.getElementById("name"); // small helpful variable

// Delete modal elements (added)
const deleteModal = document.getElementById("deleteModal");
const deleteYes = document.getElementById("deleteYes");
const deleteNo = document.getElementById("deleteNo");
let orderToDeleteId = null;

// Customize elements (moved outside My Orders)
const customizeToggle = document.getElementById("customizeToggle");
const customizePanel = document.getElementById("customizePanel");
const customizePicker = document.getElementById("customizePicker");

// --- State ---
let colors = ["Red","Blue","Green","Yellow","Purple","Orange","Pink","Black","White","Cyan","Lime"];
let cart=[], selectedBracelet="", selectedPrice=0, selectedColors=[], pendingExtra=[];
let adminLoggedIn = false;
let ordersCache = []; // store latest snapshot docs to allow re-rendering on auth changes

// --- Ensure Auth Persistence (so admin stays logged in across reloads) ---
setPersistence(auth, browserLocalPersistence).catch(e=>{
  // If persistence setting fails, ignore (browser will default)
  console.warn("setPersistence failed:", e);
});

// --- PREFILL NAME from localStorage so My Orders shows after reload ---
const storedName = localStorage.getItem('unbeadable_name');
if (storedName) {
  nameInput.value = storedName;
}

// --- RATINGS: per-browser user id so users can update their rating ---
let userRatingId = localStorage.getItem('unbeadable_uid');
if(!userRatingId){
  userRatingId = 'u_' + Math.random().toString(36).slice(2,10);
  localStorage.setItem('unbeadable_uid', userRatingId);
}

// --- Ratings UI init from localStorage (if present) ---
const savedRating = localStorage.getItem("rating");
if (savedRating) {
  stars.forEach(s => { if(s.dataset.star <= savedRating) s.classList.add("active"); });
}

// --- Star click: allow changes, save locally, push to Firestore ratings collection, update UI instantly ---
stars.forEach(star => {
  star.onclick = async () => {
    const rating = Number(star.dataset.star);
    // update local UI
    stars.forEach(s => s.classList.remove("active"));
    stars.forEach(s => { if(Number(s.dataset.star) <= rating) s.classList.add("active"); });
    // persist locally
    localStorage.setItem("rating", String(rating));
    // save user rating to Firestore (ratings collection, docId = userRatingId)
    try {
      await setDoc(doc(db, "ratings", userRatingId), {
        rating: rating,
        userName: nameInput.value ? nameInput.value.trim() : null,
        time: new Date()
      });
      console.log("Saved rating:", rating);
    } catch (e) {
      console.error("Failed to save rating to Firestore:", e);
    }
  };
});

// --- Shop Products (unchanged behavior) ---
const products = [
{name:"Normal Bracelet",price:0.75},{name:"Triple Normal",price:0.95},{name:"Fishtail",price:0.85},{name:"Inverted Fishtail",price:0.95},
{name:"Starburst",price:1.00},{name:"Honeycomb",price:1.50},{name:"Dragon Scale",price:1.75},{name:"Ladder",price:1.85},
{name:"Flower Power",price:1.00},{name:"Tropico",price:1.00},{name:"Name bracelet",price:0.85},{name:"Taffy Twist",price:1.00},
{name:"Random Color Bracelet",price:1.25},{name:"Mystery Bag Bracelet",price:1.50}
];

// --- ADDED: Bracelet images map (uses Imgur links you provided) ---
const braceletImages = {
  "Normal Bracelet": "https://i.imgur.com/4ru5gNK.jpeg",
  "Triple Normal": "https://i.imgur.com/U6lh2t2.jpeg",
  "Fishtail": "https://i.imgur.com/3KomDoK.jpeg",
  "Inverted Fishtail": "https://i.imgur.com/Jh776rQ.jpeg",
  "Starburst": "https://i.imgur.com/OsrgrM3.jpeg",
  "Honeycomb": "https://i.imgur.com/4qKTebb.jpeg",
  "Dragon Scale": "https://i.imgur.com/4Hgfu1H.jpeg",
  "Ladder": "https://i.imgur.com/4sIn0aa.jpeg",
  "Flower Power": "https://i.imgur.com/pEr93P0.jpeg",
  "Tropico": "https://i.imgur.com/jjA1q4V.jpeg",
  "Name bracelet": "https://i.imgur.com/W0z2404.jpeg",
  "Taffy Twist": "https://i.imgur.com/GTRQVGH.jpeg",
  "Random Color Bracelet": "https://i.imgur.com/EncMExO.jpeg",
  "Mystery Bag Bracelet": "https://i.imgur.com/EncMExO.jpeg"
};

// --- Color Picker & Cart functions (unchanged) ---
function renderColors(){
  const picker = document.getElementById("colorPicker");
  picker.innerHTML="";
  colors.forEach(c=>{
    const d = document.createElement("div");
    d.className="color-option"; d.style.background=c.toLowerCase();
    d.onclick = ()=>{
      if(selectedColors.includes(c)) return;
      if(selectedColors.length<5){ selectedColors.push(c); d.classList.add("selected"); }
      else { pendingExtra.push(c); extraModal.style.display="flex"; }
    };
    picker.appendChild(d);
  });
}
function openModal(n,p){ selectedBracelet=n; selectedPrice=p; selectedColors=[]; pendingExtra=[]; renderColors(); colorModal.style.display="flex"; }
closeModal.onclick = ()=> colorModal.style.display="none";
extraYes.onclick = ()=> { selectedColors.push(...pendingExtra); selectedPrice += 0.25 * pendingExtra.length; pendingExtra=[]; renderCart(); extraModal.style.display="none"; };
extraNo.onclick = ()=> { pendingExtra=[]; extraModal.style.display="none"; };
confirmColors.onclick = ()=>{ if(!selectedColors.length) return alert("Pick colors"); cart.push({name:selectedBracelet, price:selectedPrice, colors:[...selectedColors]}); renderCart(); colorModal.style.display="none"; };

function renderCart(){ 
  items.innerHTML=""; 
  let t=0; 
  cart.forEach((x,i)=>{ 
    items.innerHTML+=`<p><b>${x.name}</b> - $${x.price.toFixed(2)}<br>${x.colors.join(", ")}<button class="deleteBtn" onclick="removeFromCart(${i})">Remove</button></p>`; 
    t+=x.price; 
  }); 
  total.innerText=t.toFixed(2); 
}
window.removeFromCart = (i)=>{ cart.splice(i,1); renderCart(); };

// --- Add Products: include <img> above product name (images added, nothing removed) ---
products.forEach(p=>{
  const c = document.createElement("div"); c.className="card";
  const imgSrc = braceletImages[p.name] || "https://source.unsplash.com/400x400/?rainbow+loom+bracelet";
  c.innerHTML=`
    <img class="bracelet-img" src="${imgSrc}" alt="${p.name}">
    <h3>${p.name}</h3>
    <div class="price">$${p.price.toFixed(2)}</div>
    <button>Add</button>
  `;
  c.querySelector("button").onclick = ()=>{
    if(p.name.includes("Random") || p.name.includes("Mystery")){
      selectedBracelet=p.name; selectedPrice=p.price; selectedColors=[];
      for(let i=0;i<5;i++){ selectedColors.push(colors[Math.floor(Math.random()*colors.length)]); }
      cart.push({name:selectedBracelet, price:selectedPrice, colors:[...selectedColors]}); renderCart();
      alert(`${p.name} added with 5 random colors!`);
    } else { openModal(p.name,p.price); }
  };
  shopGrid.appendChild(c);
});

// --- Checkout & Tip (unchanged) ---
checkout.onclick = ()=>{ 
  if(!nameInput.value || !cart.length) return alert("Missing info"); 
  tipModal.style.display="flex"; 
};
tipModal.querySelectorAll("button").forEach(b=>{
  b.onclick=async()=>{
    const tip = parseInt(b.dataset.tip);
    tipModal.style.display="none";
    const userName = nameInput.value.trim();
    if(!userName) return alert("Please enter your name!");
    // save the name locally so My Orders is prefilled & persists
    localStorage.setItem('unbeadable_name', userName);
    await addDoc(collection(db,"orders"),{
      name: userName,
      cart,
      status:"pending",
      rating:localStorage.getItem("rating") || null,
      tip:tip,
      time:new Date()
    });
    cart=[]; renderCart();
    alert(`Order placed!${tip>0?" Tip added: $"+tip:""}`);
  };
});

// --- Admin login/logout (button toggles) (unchanged behavior) ---
adminLogin.onclick = async ()=>{
  if (!adminLoggedIn) {
    // attempt sign in
    try {
      await signInWithEmailAndPassword(auth, adminEmail.value, adminPass.value);
      // success handled by onAuthStateChanged
    } catch(e){ alert("Admin login failed"); }
  } else {
    try {
      await signOut(auth);
      adminLoggedIn = false;
      adminLogin.innerText = "Login";
      localStorage.removeItem('unbeadable_admin');
      alert("Admin logged out");
    } catch(e) { console.warn("signOut failed", e); }
  }
};

// --- onAuthStateChanged: keeps adminLoggedIn true when Firebase has a session (unchanged behavior) ---
onAuthStateChanged(auth, (user) => {
  if (user) {
    adminLoggedIn = true;
    localStorage.setItem('unbeadable_admin', '1');
    adminLogin.innerText = "Logout";
    ordersDiv.scrollIntoView({behavior:"smooth", block:"center"});
    renderOrdersFromCache();
  } else {
    adminLoggedIn = false;
    localStorage.removeItem('unbeadable_admin');
    adminLogin.innerText = "Login";
    renderOrdersFromCache();
  }
});

// --- helper to render using the cached snapshot docs (creates DOM so admin buttons can attach) ---
function renderOrdersFromCache(){
  ordersDiv.innerHTML = "";
  myOrdersDiv.innerHTML = "";
  const currentName = nameInput.value.trim();
  ordersCache.forEach(docSnap=>{
    const data = docSnap.data();
    const id = docSnap.id;
    const totalPrice = data.cart.reduce((a,b)=>a+b.price,0).toFixed(2);
    const itemsList = data.cart.map(c=>`${c.name} (${c.colors.join(", ")})`).join("<br>");
    const time = data.time && data.time.toDate ? data.time.toDate().toLocaleString() : new Date(data.time.seconds*1000).toLocaleString();

    const wrapper = document.createElement("div");
    wrapper.innerHTML = `<p><b>${data.name}</b> - $${totalPrice} - Tip: $${data.tip} - <span class="${data.status==='done'?'doneBadge':'pendingBadge'}">${data.status}</span><br>${itemsList}<br><small>${time}</small></p><hr>`;

    if(adminLoggedIn){
      const btn = document.createElement("button");
      btn.className = "adminOrderBtn";
      btn.textContent = "Mark Complete";
      btn.addEventListener("click", async () => {
        try {
          await updateDoc(doc(db, "orders", id), { status: "complete" });
        } catch(err){
          console.error("Failed to update status:", err);
          alert("Failed to update order status.");
        }
      });
      wrapper.querySelector("p").appendChild(btn);

      // Delete Button (added)
      const delBtn = document.createElement("button");
      delBtn.className = "adminOrderBtn";
      delBtn.style.background = "#ef4444";
      delBtn.textContent = "Delete";
      delBtn.addEventListener("click", () => {
        orderToDeleteId = id;
        deleteModal.style.display = "flex";
      });
      wrapper.querySelector("p").appendChild(delBtn);

      ordersDiv.appendChild(wrapper);
    }

    if(currentName && data.name === currentName){
      const myWrap = document.createElement("div");
      myWrap.innerHTML = `<p><b>${data.name}</b> - $${totalPrice} - Tip: $${data.tip} - <span class="${data.status==='done'?'doneBadge': data.status==='complete'?'doneBadge':'pendingBadge'}">${data.status}</span><br>${itemsList}<br><small>${time}</small></p><hr>`;
      myOrdersDiv.appendChild(myWrap);
    }
  });
}

// --- Real-time Orders: cache docs and render via renderOrdersFromCache (unchanged) ---
onSnapshot(collection(db,"orders"), snapshot=>{
  ordersCache = [];
  snapshot.forEach(doc => ordersCache.push(doc));
  renderOrdersFromCache();
});

// --- Delete modal handlers (unchanged) ---
deleteNo.onclick = () => {
  orderToDeleteId = null;
  deleteModal.style.display = "none";
};
deleteYes.onclick = async () => {
  if (!orderToDeleteId) return;
  try {
    await deleteDoc(doc(db, "orders", orderToDeleteId));
    orderToDeleteId = null;
    deleteModal.style.display = "none";
  } catch(err) {
    console.error("Delete failed:", err);
    alert("Failed to delete order.");
  }
};

// --- Toggle Panels (unchanged) ---
myOrdersBtn.onclick = ()=>{ myOrdersPanel.style.display = myOrdersPanel.style.display==="block"?"none":"block"; };

// --- RATINGS AGGREGATION: AppStore-like bar graph (live) ---
// initialize bars (5..1)
const ratingBarsContainer = document.getElementById('ratingBars');
function buildEmptyBars(){
  ratingBarsContainer.innerHTML = '';
  for(let star=5; star>=1; star--){
    const row = document.createElement('div');
    row.className = 'barContainer';
    row.innerHTML = `<div class="barLabel">${star}</div><div class="barWrap"><div class="barBg"><div class="bar" data-star="${star}" style="width:0%"></div></div><div class="barCount" data-count="${star}">0</div></div>`;
    ratingBarsContainer.appendChild(row);
  }
}
buildEmptyBars();

// Listen to ratings collection (realtime) and update graph
onSnapshot(collection(db,"ratings"), snapshot=>{
  const counts = [0,0,0,0,0]; // index 0=>1 star ... 4=>5 star
  let sum=0, total=0;
  snapshot.forEach(docSnap=>{
    const d = docSnap.data();
    const r = Number(d.rating) || 0;
    if(r>=1 && r<=5){
      counts[r-1] += 1;
      sum += r;
      total += 1;
    }
  });
  const avg = total ? (sum/total).toFixed(2) : "0.00";
  document.getElementById('avgRating').innerText = `Average: ${avg} ★`;

  // update bar elements: we built them 5->1 (descending). counts index is 1->5 at 0..4
  // need total to compute percent
  const bars = ratingBarsContainer.querySelectorAll('.bar');
  // bars are in descending order data-star 5..1
  bars.forEach(barEl => {
    const star = Number(barEl.getAttribute('data-star'));
    const c = counts[star-1] || 0;
    const pct = total ? (c/total*100) : 0;
    barEl.style.width = pct + '%';
    // update the corresponding count text
    const parent = barEl.closest('.barWrap');
    if(parent){
      const countEl = parent.querySelector('.barCount');
      if(countEl) countEl.innerText = c;
    }
  });
});

// --- Ratings toggle button already present (keeps original behaviour but uses new graph) ---
toggleRatingGraph.onclick = async ()=>{
  const panel = document.getElementById("ratingGraphPanel");
  panel.style.display = panel.style.display==="block"?"none":"block";
};

/* ----------------------------
   CUSTOMIZE PANEL LOGIC (ADDED)
   - Adds color swatches under "My Orders" when Customize is clicked
   - Selecting a color updates CSS variables to change the GUI accent
   - White is intentionally excluded
   - Accent choice is saved to localStorage and applied on load
   ---------------------------- */

// Palette for GUI customization (no white)
const customizeColors = [
  "#7c3aed", // original purple
  "#ef4444", // red
  "#10b981", // green
  "#f59e0b", // amber
  "#0ea5e9", // blue
  "#ec4899", // pink
  "#6366f1", // indigo
  "#f97316", // orange
  "#14b8a6", // teal
  "#111827"  // near-black (not white)
];

// utility: darken/lighten hex by percent (negative = darker)
function shadeHex(hex, percent){
  // hex like #rrggbb
  const num = parseInt(hex.slice(1),16);
  let r = (num >> 16) + Math.round(2.55 * percent);
  let g = (num >> 8 & 0x00FF) + Math.round(2.55 * percent);
  let b = (num & 0x0000FF) + Math.round(2.55 * percent);
  r = Math.max(0, Math.min(255, r));
  g = Math.max(0, Math.min(255, g));
  b = Math.max(0, Math.min(255, b));
  return "#" + ( (1 << 24) + (r << 16) + (g << 8) + b ).toString(16).slice(1);
}

// build customize swatches
function buildCustomizePicker(){
  customizePicker.innerHTML = "";
  customizeColors.forEach(color => {
    const d = document.createElement('div');
    d.className = "color-option";
    d.style.background = color;
    d.title = color;
    d.onclick = () => {
      applyAccentColor(color);
      // highlight selection visually in picker
      customizePicker.querySelectorAll('.color-option').forEach(e=>e.classList.remove('selected'));
      d.classList.add('selected');
    };
    customizePicker.appendChild(d);
  });
}

// apply accent color across GUI by updating CSS variables and saving preference
function applyAccentColor(hex){
  // save
  localStorage.setItem('unbeadable_accent', hex);
  // compute hover color a bit darker
  const hover = shadeHex(hex, -10);
  document.documentElement.style.setProperty('--accent', hex);
  document.documentElement.style.setProperty('--accent-hover', hover);
  // also update selected borders for pickers that used .selected default color
  // update any .color-option.selected border color if needed (not strictly required)
}

// read saved accent and apply
const savedAccent = localStorage.getItem('unbeadable_accent');
if(savedAccent){
  applyAccentColor(savedAccent);
  // also mark picker selected later after build
}

// hook up toggle behavior
customizeToggle.onclick = () => {
  customizePanel.style.display = customizePanel.style.display === "block" ? "none" : "block";
  // on first open, build picker (idempotent)
  if(customizePicker.children.length === 0) {
    buildCustomizePicker();
    // if saved accent exists, mark selected
    const saved = localStorage.getItem('unbeadable_accent');
    if(saved){
      customizePicker.querySelectorAll('.color-option').forEach(el=>{
        if(el.style.background.toLowerCase() === saved.toLowerCase()) el.classList.add('selected');
      });
    }
  }
};

// build initial customize picker invisibly (optional)
buildCustomizePicker();

// ensure the header/button/etc use the current variable values on load (already applied by CSS variable)
if(!savedAccent){
  // default remains original purple already set in :root
}

/* ----------------------------
   END CUSTOMIZE LOGIC
   ---------------------------- */

</script>

</body>
</html>

